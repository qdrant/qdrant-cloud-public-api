name: Pull Request
on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
permissions:
  contents: read
  pull-requests: write
  id-token: write
jobs:
  linting:
    name: Linting & checking uncommitted changes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
      - uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
      - name: Setup access for private go modules
        run: |
          git config --global url.'https://${{ secrets.GH_REPO_READ_TOKEN }}@github.com'.insteadOf 'https://github.com'
      - name: Install buf plugins
        run: make buf/plugins
      - uses: bufbuild/buf-action@v1
        with:
          # Don't push the schema to the Buf Schema Registry
          push: false
          # Optional GitHub token for API requests. Ensures requests aren't rate limited.
          github_token: ${{ secrets.GITHUB_TOKEN }}
      # make sure the PR includes the updated generated code.
      - name: Install uv
        uses: astral-sh/setup-uv@v5
      - name: "Generate code"
        run: make generate ALLOW_BREAKING=true
      - name: "Compile Go files"
        run: make build-go
      - name: "Check uncommited changes"
        uses: CatChen/check-git-status-action@v1
        with:
          fail-if-not-clean: true
          request-changes-if-not-clean: true
          request-changes-comment: |
            It looks like the PR doesn't include updates for the generated code.

            Please make sure you've run the following commands from the root directory:

            ```shell
            make generate
            ```
            Once you've added them, you can dismiss this review.

  publish-packages:
    name: Publish PR Packages
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository

    permissions:
      pull-requests: write
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Publish packages
        id: publish
        uses: ./.github/actions/publish-packages
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}
          version_source: ${{ github.ref }}
          pr_number: ${{ github.event.pull_request.number }}
          pr_sha: ${{ github.event.pull_request.head.sha }}
