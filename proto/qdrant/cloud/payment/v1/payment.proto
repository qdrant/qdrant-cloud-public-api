syntax = "proto3";

package qdrant.cloud.payment.v1;

import "buf/validate/validate.proto";
import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "qdrant/cloud/common/v1/common.proto";

// PaymentService is the API used to manage payment settings.
service PaymentService {
  // Lists all payment information known by the system for the provided account.
  // Required permissions:
  // - read:payment_information
  rpc ListPaymentInformation(ListPaymentInformationRequest) returns (ListPaymentInformationResponse) {
    // permissions
    option (qdrant.cloud.common.v1.permissions) = "read:payment_information";
    // gRPC Gateway REST call
    option (google.api.http) = {get: "/api/payment/v1/accounts/{account_id}/payment-information"};
  }
  // Gets the payment information identified by the given ID.
  // Required permissions:
  // - read:payment_information
  rpc GetPaymentInformation(GetPaymentInformationRequest) returns (GetPaymentInformationResponse) {
    // permissions
    option (qdrant.cloud.common.v1.permissions) = "read:payment_information";
    // gRPC Gateway REST call
    option (google.api.http) = {get: "/api/payment/v1/accounts/{account_id}/payment-information/{payment_information_id}"};
  }
  // Updates the payment information for the account.
  // This method is used to update the payment information details, such as billing address.
  // Required permissions:
  // - write:payment_information
  rpc UpdatePaymentInformation(UpdatePaymentInformationRequest) returns (UpdatePaymentInformationResponse) {
    // permissions
    option (qdrant.cloud.common.v1.permissions) = "write:payment_information";
    // custom account-id expression
    option (qdrant.cloud.common.v1.account_id_expression) = "payment_information.account_id";
    // gRPC Gateway REST call
    option (google.api.http) = {
      put: "/api/payment/v1/accounts/{payment_information.account_id}/payment-information/{payment_information.id}"
      body: "*"
    };
  }
  // Delete the payment information identified by the given ID.
  // Required permissions:
  // - write:payment_information
  // TODO: This endpoint is not supported in the current version of the API. Should we remove it from here?
  rpc DeletePaymentInformation(DeletePaymentInformationRequest) returns (DeletePaymentInformationResponse) {
    // permissions
    option (qdrant.cloud.common.v1.permissions) = "write:payment_information";
    // gRPC Gateway REST call
    option (google.api.http) = {delete: "/api/payment/v1/accounts/{account_id}/payment-information/{payment_information_id}"};
  }
  // Get the Stripe Checkout session by its ID.
  // This method is used to retrieve the session details after it has been created.
  // Required permissions:
  // - write:payment_information
  rpc GetStripeCheckoutSession(GetStripeCheckoutSessionRequest) returns (GetStripeCheckoutSessionResponse) {
    // permissions
    option (qdrant.cloud.common.v1.permissions) = "write:payment_information";
    // gRPC Gateway REST call
    option (google.api.http) = {get: "/api/payment/v1/accounts/{account_id}/stripe-session/{session_id}"};
  }
  // Initiates the creation of a Stripe Checkout session for the specified account.
  // This session can be used by the client (usually via frontend) to interact directly with Stripe's hosted payment page.
  // Required permissions:
  // - write:payment_information
  rpc CreateStripeCheckoutSession(CreateStripeCheckoutSessionRequest) returns (CreateStripeCheckoutSessionResponse) {
    // permissions
    option (qdrant.cloud.common.v1.permissions) = "write:payment_information";
    // gRPC Gateway REST call
    option (google.api.http) = {post: "/api/payment/v1/accounts/{account_id}/stripe-session"};
  }
  // Updates the current payment information associated with the account.
  // After this change, the new payment information will be used for all future charges.
  // This does not create a new payment information, it simply switches to one already linked to the account.
  // Required permissions:
  // - write:payment_information
  rpc SetDefaultPaymentInformation(SetDefaultPaymentInformationRequest) returns (SetDefaultPaymentInformationResponse) {
    // permissions
    option (qdrant.cloud.common.v1.permissions) = "write:payment_information";
    // gRPC Gateway REST call
    option (google.api.http) = {put: "/api/payment/v1/accounts/{account_id}/set-default-payment-information"};
  }
}

// Request to list payment information for a specific account.
message ListPaymentInformationRequest {
  // The identifier of the account (in GUID format).
  // This is a required field.
  string account_id = 1 [(buf.validate.field).string = {uuid: true}];
}

// Response containing a list of payment information.
message ListPaymentInformationResponse {
  // The list of payment information.
  repeated PaymentInformation items = 1;
}

// Request to get payment information by id.
message GetPaymentInformationRequest {
  // The identifier of the account (in GUID format).
  // This is a required field.
  string account_id = 1 [(buf.validate.field).string = {uuid: true}];
  // The identifier of the payment information (in GUID format).
  // This is a required field.
  string payment_information_id = 2 [(buf.validate.field).string = {uuid: true}];
}

// Response containing the payment information.
message GetPaymentInformationResponse {
  // The actual payment information.
  PaymentInformation payment_information = 1;
}

// UpdatePaymentInformationRequest is the request for the UpdatePaymentInformation function
message UpdatePaymentInformationRequest {
  // The payment information to update.
  PaymentInformation payment_information = 2;
}

// UpdatePaymentInformationResponse is the response from the UpdatePaymentInformation function
message UpdatePaymentInformationResponse {
  // The updated payment information.
  PaymentInformation payment_information = 1;
}

// DeletePaymentInformationRequest is the request for the DeletePaymentInformation function
message DeletePaymentInformationRequest {
  // The identifier of the account (in GUID format).
  // This is a required field.
  string account_id = 1 [(buf.validate.field).string = {uuid: true}];
  // The identifier of the payment information (in GUID format).
  // This is a required field.
  string payment_information_id = 2 [(buf.validate.field).string = {uuid: true}];
}

// DeletePaymentInformationResponse is the response from the DeletePaymentInformation function
message DeletePaymentInformationResponse {
  // Empty
}

// GetStripeCheckoutSessionRequest is the request for the GetStripeCheckoutSession function
message GetStripeCheckoutSessionRequest {
  // The identifier of the account (in GUID format).
  // This is a required field.
  string account_id = 1 [(buf.validate.field).string = {uuid: true}];
  // The identifier of the Stripe session.
  // This is a required field.
  string session_id = 2;
}

// GetStripeCheckoutSessionResponse is the response from the GetStripeCheckoutSession function
message GetStripeCheckoutSessionResponse {
  // The Stripe session for the account.
  StripeCheckoutSession stripe_session = 1;
}

// CreateStripeCheckoutSessionRequest is the request for the CreateStripeCheckoutSession function
message CreateStripeCheckoutSessionRequest {
  // The identifier of the account (in GUID format).
  // This is a required field.
  string account_id = 1 [(buf.validate.field).string = {uuid: true}];
  // Redirect URL to which the user will be redirected after the payment setup is completed.
  string redirect_url = 2;
}

// CreateStripeCheckoutSessionResponse is the response from the CreateStripeCheckoutSession function
message CreateStripeCheckoutSessionResponse {
  // Stripe session created for payment method setup or collection.
  StripeCheckoutSession stripe_session = 1;
}

// SetDefaultPaymentInformationRequest is the request for the ChangePaymentInformation function
message SetDefaultPaymentInformationRequest {
  // The identifier of the account (in GUID format).
  string account_id = 1 [(buf.validate.field).string = {uuid: true}];
  // The identifier of the new payment information to set.
  string payment_information_id = 3 [(buf.validate.field).string = {min_len: 1}];
}

// SetDefaultPaymentInformationResponse is the response returned after a successful update.
message SetDefaultPaymentInformationResponse {
  // New payment information that has been set for the account.
  PaymentInformation payment_information = 1;
}

// Represents a Stripe Session abstraction containing Checkout session and SetupIntent references.
// buf:lint:ignore QDRANT_CLOUD_REQUIRED_ENTITY_FIELDS
message StripeCheckoutSession {
  // The unique identifier of the Stripe Checkout session.
  string id = 1;
  // The URL to redirect the user to complete the Checkout session.
  // This may be null if the session is incomplete or improperly initialized.
  optional string url = 2;
  // The Stripe customer ID associated with this session.
  string customer = 3;
  // The ID of the associated Stripe SetupIntent.
  string setup_intent_id = 4;
  // The status of the associated Stripe SetupIntent.
  StripeSetupIntentStatus setup_intent_status = 5;
  // The payment method attached to the associated SetupIntent.
  string setup_intent_payment_method = 6;
}

// Represents a payment information.
// buf:lint:ignore QDRANT_CLOUD_REQUIRED_ENTITY_FIELDS
// TODO: Is payment method a better name?
message PaymentInformation {
  // Unique identifier for the payment information (in GUID format).
  // This is a read-only field and will be available after a payment information is created.
  string id = 1;
  option (buf.validate.message).cel = {
    id: "payment_information.id"
    message: "value must be a valid UUID"
    expression: "this.id.matches(\'^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$\') || !has(this.created_at)"
  };
  // The identifier of the account (in GUID format).
  // This is a required field.
  string account_id = 2 [(buf.validate.field).string = {uuid: true}];
  // The type of the payment information provider.
  // This is a required field.
  PaymentProviderType type = 3;
  // The customer account identifier in the payment provider system.
  // This is a required field.
  string payment_provider_id = 4;
  // Represents the payment method details, such as card information.
  // This field is optional and only available for payment provider type Stripe for now.
  optional PaymentMethod payment_method = 5;
  // The billing address associated with the payment information.
  // This field is optional and only available for payment provider type Stripe.
  optional BillingAddress billing_address = 6;
  // The timestamp when the payment information was created.
  // This is a read-only field and will be available after a payment information is created.
  google.protobuf.Timestamp created_at = 7;
  // The timestamp when the payment information was last updated.
  // This is a read-only field and will be available after a payment information is created.
  google.protobuf.Timestamp last_modified_at = 8;
  // The tax ID associated with the payment information.
  // This is an optional field.
  optional string tax_id = 9 [(buf.validate.field).string = {min_len: 1}];
  // The us default flag indicates if this payment information is the default one for the account.
  // Default payment information is used for all charges in the account.
  bool is_default = 10;
  // Payment information status.
  PaymentInformationStatus status = 11;
}

// PaymentProviderType defines the type of payment information.
enum PaymentProviderType {
  // Unspecified type, should not be used.
  PAYMENT_PROVIDER_TYPE_UNSPECIFIED = 0;
  // Stripe payment information.
  PAYMENT_PROVIDER_TYPE_STRIPE = 1;
  // AWS marketplace payment information.
  PAYMENT_PROVIDER_TYPE_AWS_MARKETPLACE = 2;
  // Google Cloud Platform marketplace payment information.
  PAYMENT_PROVIDER_TYPE_GCP_MARKETPLACE = 3;
  // Azure marketplace payment information.
  PAYMENT_PROVIDER_TYPE_AZURE_MARKETPLACE = 4;
  // Custom payment information. This is used for custom payment methods that do not fit into the predefined categories.
  PAYMENT_PROVIDER_TYPE_CUSTOM = 5;
}

// PaymentInformationStatus defines the status of the payment information.
enum PaymentInformationStatus {
  // Unspecified status, should not be used.
  PAYMENT_INFORMATION_STATUS_UNSPECIFIED = 0;
  // The payment information is active and can be used for payments.
  PAYMENT_INFORMATION_STATUS_ACTIVE = 1;
  // The payment information is inactive and cannot be used for payments.
  PAYMENT_INFORMATION_STATUS_INACTIVE = 2;
  // The payment information is pending verification or setup.
  PAYMENT_INFORMATION_STATUS_PENDING = 3;
}

// Represents a billing address for a payment information.
message BillingAddress {
  // The name of the person or entity associated with the billing address.
  string name = 1 [(buf.validate.field).string = {min_len: 1}];
  // The first line of the billing address.
  string line1 = 2 [(buf.validate.field).string = {min_len: 1}];
  // The second line of the billing address.
  // This is an optional field.
  optional string line2 = 3 [(buf.validate.field).string = {min_len: 1}];
  // The postal code of the billing address.
  // This is an optional field.
  optional string postal_code = 4 [(buf.validate.field).string = {min_len: 1}];
  // The city of the billing address.
  string city = 5 [(buf.validate.field).string = {min_len: 1}];
  // The state or province of the billing address.
  string state = 6 [(buf.validate.field).string = {min_len: 1}];
  // The country of the billing address.
  string country = 7 [(buf.validate.field).string = {min_len: 1}];
  // The formatted country name.
  string country_formatted = 8 [(buf.validate.field).string = {min_len: 1}];
  // The formatted state or province name.
  string state_formatted = 9 [(buf.validate.field).string = {min_len: 1}];
  // Indicates if the country supports tax.
  bool tax_supported_country = 10;
}

// Represents payment method
// buf:lint:ignore QDRANT_CLOUD_REQUIRED_ENTITY_FIELDS
message PaymentMethod {
  // The identifier of the payment method.
  string id = 1 [(buf.validate.field).string = {min_len: 1}];
  // Card details.
  Card card = 2;
}

// Represents payment method card details
message Card {
  // The brand of the card (e.g., "Visa", "Mastercard").
  string brand = 1;
  // The last 4 digits of the card number.
  string last4 = 2;
  // The expiration month of the card.
  int32 expiration_month = 3;
  // The expiration year of the card.
  int32 expiration_year = 4;
}

// Represents the status of a SetupIntent in Stripe.
enum StripeSetupIntentStatus {
  // Default unspecified value.
  STRIPE_SETUP_INTENT_STATUS_UNSPECIFIED = 0;
  // A payment method is required to proceed.
  STRIPE_SETUP_INTENT_STATUS_REQUIRES_PAYMENT_METHOD = 1;
  // The SetupIntent is ready to be confirmed.
  STRIPE_SETUP_INTENT_STATUS_REQUIRES_CONFIRMATION = 2;
  // The SetupIntent requires further action (e.g., 3D Secure).
  STRIPE_SETUP_INTENT_STATUS_REQUIRES_ACTION = 3;
  // The SetupIntent is being processed.
  STRIPE_SETUP_INTENT_STATUS_PROCESSING = 4;
  // The SetupIntent has been canceled.
  STRIPE_SETUP_INTENT_STATUS_CANCELED = 5;
  // The SetupIntent has succeeded.
  STRIPE_SETUP_INTENT_STATUS_SUCCEEDED = 6;
}
